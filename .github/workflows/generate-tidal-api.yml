name: Generate API Types and Create PR

on:
  workflow_dispatch:
    inputs:
      use_downloaded_spec:
        description: 'Whether to use the downloaded spec from the artifacts'
        required: false
        type: string
        default: 'false'
  workflow_call:
    inputs:
      use_downloaded_spec:
        description: 'Whether to use the downloaded spec from the artifacts'
        required: false
        type: string
        default: 'false'
    secrets:
      token:
        required: true

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-api:
    runs-on: ubuntu-latest
    env:
      API_FOLDER: packages/api
      GENERATED_FILE: src/allAPI.generated.ts
      SPEC_FILE: bin/tidal-api-oas.json
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4
        with:
          run_install: false
      - uses: actions/setup-node@v6
        with:
          node-version: '24'

      - name: Install dependencies
        run: |
          pnpm install
      - name: Check for existing PR
        id: check_pr
        uses: ./.github/actions/check-api-pr

      - name: Checkout PR branch if exists
        if: steps.check_pr.outputs.existing_pr == 'true'
        env:
          PR_BRANCH: ${{ steps.check_pr.outputs.pr_branch }}
        run: |
          git fetch origin "$PR_BRANCH"
          git checkout "$PR_BRANCH"
          echo "Using existing PR branch: $PR_BRANCH"

      - name: Download API spec artifact
        if: ${{ inputs.use_downloaded_spec == 'true' }}
        uses: actions/download-artifact@v7
        with:
          name: api-spec
          path: /tmp/api-check
      - name: Generate API types
        env:
          USE_DOWNLOADED_SPEC: ${{ inputs.use_downloaded_spec }}
        run: |
          cd "$API_FOLDER"
          mkdir -p bin

          if [ "$USE_DOWNLOADED_SPEC" == "true" ] && [ -f "/tmp/api-check/latest-api.json" ]; then
            echo "Using downloaded API spec"
            cp /tmp/api-check/latest-api.json "$SPEC_FILE"
          else
            echo "Downloading API spec as part of generation"
            curl -s https://tidal-music.github.io/tidal-api-reference/tidal-api-oas.json -o "$SPEC_FILE"
          fi
          pnpm run generateTypes "$SPEC_FILE" --output-file "$GENERATED_FILE"

      - name: Check for changes
        id: check_for_changes
        run: |
          cd "$API_FOLDER"
          git add "$GENERATED_FILE" "$SPEC_FILE"
          changes_in_generated=$(git status -s "$GENERATED_FILE" | sed 's/"//g')
          changes_in_spec=$(git status -s "$SPEC_FILE" | sed 's/"//g')

          echo "Changes in $GENERATED_FILE:"
          echo "$changes_in_generated"
          echo "Changes in $SPEC_FILE:"
          echo "$changes_in_spec"

          SPEC_VERSION=$(jq -r '.info.version // empty' "$SPEC_FILE" 2>/dev/null)
          if [ -z "$SPEC_VERSION" ]; then
            SPEC_VERSION="unknown"
          fi
          echo "API Spec Version: $SPEC_VERSION"

          if [ -n "$changes_in_generated" ] || [ -n "$changes_in_spec" ]; then
            changes_detected="true"
            changed_file_count=0
            if [ -n "$changes_in_generated" ]; then
              changed_file_count=$((changed_file_count + 1))
            fi
            if [ -n "$changes_in_spec" ]; then
              changed_file_count=$((changed_file_count + 1))
            fi
          else
            changes_detected="false"
            changed_file_count=0
            echo "No changes detected in generated files."
          fi

          {
            echo 'CHANGES_IN_GENERATED<<EOF'
            echo "$changes_in_generated"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

          {
            echo 'CHANGES_IN_SPEC<<EOF'
            echo "$changes_in_spec"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

          echo "CHANGES_DETECTED=$changes_detected" >> $GITHUB_OUTPUT
          echo "CHANGED_FILE_COUNT=$changed_file_count" >> $GITHUB_OUTPUT
          echo "SPEC_VERSION=$SPEC_VERSION" >> $GITHUB_OUTPUT

      - name: No Changes Found - Say Goodbye
        if: ${{ steps.check_for_changes.outputs.CHANGES_DETECTED == 'false' }}
        run: |
            echo "No changes found after generation. Good bye"

      - name: Prepare git and define a branch name
        id: prepare_git_and_define_branch_name
        if: ${{ steps.check_for_changes.outputs.CHANGES_DETECTED == 'true' }}
        run: |
          git config user.email "svc-github-tidal-music-tools@block.xyz"
          git config user.name "TIDAL Music Tools"

          # Use a consistent branch name for API updates, so we can edit the PR later
          standard_branch_name="tidal-music-tools/auto-update-tidal-api"

          echo "BRANCH_NAME=$standard_branch_name" >> "$GITHUB_OUTPUT"

      - name: Commit changes
        id: commit_changes
        if: ${{ steps.check_for_changes.outputs.CHANGES_DETECTED == 'true' }}
        env:
          SPEC_VERSION: ${{ steps.check_for_changes.outputs.SPEC_VERSION }}
          CHANGED_FILE_COUNT: ${{ steps.check_for_changes.outputs.CHANGED_FILE_COUNT }}
          CHANGES_IN_GENERATED: ${{ steps.check_for_changes.outputs.CHANGES_IN_GENERATED }}
          CHANGES_IN_SPEC: ${{ steps.check_for_changes.outputs.CHANGES_IN_SPEC }}
          EXISTING_PR: ${{ steps.check_pr.outputs.existing_pr }}
          PR_BRANCH: ${{ steps.check_pr.outputs.pr_branch }}
        run: |
          commit_title="Update Tidal API to v${SPEC_VERSION} - ${CHANGED_FILE_COUNT} files changed"

          commit_body="Changes in generated file:\n${CHANGES_IN_GENERATED}\n\nChanges in spec file:\n${CHANGES_IN_SPEC}"
          commit_body=$(echo -e "$commit_body")

          git add "$API_FOLDER/$GENERATED_FILE" "$API_FOLDER/$SPEC_FILE"

          standard_branch_name="tidal-music-tools/auto-update-tidal-api"

          if [ "$EXISTING_PR" == "true" ]; then
            branch_name="$PR_BRANCH"

            git fetch origin "$branch_name" || true

            if git diff --quiet "origin/$branch_name" HEAD -- "$API_FOLDER/$GENERATED_FILE" "$API_FOLDER/$SPEC_FILE"; then
              echo "No new changes compared to existing PR branch - skipping update"
              echo "branch_name=$branch_name" >> $GITHUB_OUTPUT
              echo "commit_made=false" >> $GITHUB_OUTPUT
            else
              echo "Changes detected compared to existing PR branch - updating"
              git commit -m "$commit_title"$'\n\n'"$commit_body"
              echo "branch_name=$branch_name" >> $GITHUB_OUTPUT
              echo "commit_made=true" >> $GITHUB_OUTPUT
            fi
          else
            git checkout -b "$standard_branch_name"
            git commit -m "$commit_title"$'\n\n'"$commit_body"
            branch_name="$standard_branch_name"
            echo "branch_name=$branch_name" >> $GITHUB_OUTPUT
            echo "commit_made=true" >> $GITHUB_OUTPUT
          fi

      - name: Push changes
        if: ${{ steps.check_for_changes.outputs.CHANGES_DETECTED == 'true' && steps.commit_changes.outputs.commit_made == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH_NAME: ${{ steps.commit_changes.outputs.branch_name }}
        run: |
          if git ls-remote --exit-code origin "$BRANCH_NAME" >/dev/null 2>&1; then
            echo "Remote branch exists - force pushing changes to: $BRANCH_NAME"
            git push origin HEAD:"$BRANCH_NAME" --force
          else
            echo "Creating new branch: $BRANCH_NAME"
            git push --set-upstream origin "$BRANCH_NAME"
          fi

      - name: Create or Update Pull Request
        if: ${{ steps.check_for_changes.outputs.CHANGES_DETECTED == 'true' && steps.commit_changes.outputs.commit_made == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SPEC_VERSION: ${{ steps.check_for_changes.outputs.SPEC_VERSION }}
          CHANGED_FILE_COUNT: ${{ steps.check_for_changes.outputs.CHANGED_FILE_COUNT }}
          CHANGES_IN_GENERATED: ${{ steps.check_for_changes.outputs.CHANGES_IN_GENERATED }}
          CHANGES_IN_SPEC: ${{ steps.check_for_changes.outputs.CHANGES_IN_SPEC }}
          EXISTING_PR: ${{ steps.check_pr.outputs.existing_pr }}
          PR_NUMBER: ${{ steps.check_pr.outputs.pr_number }}
          PR_HEAD_BRANCH: ${{ steps.prepare_git_and_define_branch_name.outputs.BRANCH_NAME }}
          REPO: ${{ github.repository }}
        run: |
          current_date=$(date)
          pr_title="Automatic Tidal API module update to v${SPEC_VERSION} - ${CHANGED_FILE_COUNT} files changed"

          pr_body="Updated Tidal API to version **v${SPEC_VERSION}**\n\n**Changes in Generated file:**\n\n${CHANGES_IN_GENERATED}\n\n**Changes in Spec file:**\n\n${CHANGES_IN_SPEC}\n\nAutomatically generated on $current_date\n\nThis PR is automatically updated when API changes are detected."
          pr_body=$(echo -e "$pr_body")

          if [ "$EXISTING_PR" == "true" ]; then
            pr_data=$(jq -n --arg title "$pr_title" \
                              --arg body "$pr_body" \
                              '{title: $title, body: $body}')

            curl -X PATCH \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              -d "$pr_data" \
              "https://api.github.com/repos/${REPO}/pulls/${PR_NUMBER}"

            echo "Updated existing PR #${PR_NUMBER}"
          else
            pr_data=$(jq -n --arg title "$pr_title" \
                              --arg head "$PR_HEAD_BRANCH" \
                              --arg base "main" \
                              --arg body "$pr_body" \
                              '{title: $title, head: $head, base: $base, body: $body}')

            curl -X POST \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              -d "$pr_data" \
              "https://api.github.com/repos/${REPO}/pulls"

            echo "Created new PR"
          fi
