name: Run Unit Tests

on:
  workflow_call:

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    permissions:
      # Required to put a comment into the pull-request
      pull-requests: write
    name: Run Unit Tests
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup
      - name: Prepare test user for player tests
        id: json
        run: |
          echo ${{ env.TEST_USER }} | base64 -d > test-user.json
          json=$(cat test-user.json)
          replacement=${{ secrets.PLAYER_REFRESH_TOKEN }}
          fixed_json="$(echo ${json/\[TOKEN\]/$replacement})"
          encoded_json=$(echo "$fixed_json" | base64 | tr -d '\n')
          echo "encoded=\"$encoded_json\"" >> $GITHUB_OUTPUT
        env:
          TEST_USER: ${{ secrets.PLAYER_TEST_USER }}
      - name: Run Tests
        run: |
          pnpm test:coverage
        env:
          TEST_USER: ${{ steps.json.outputs.encoded }}
      - name: Report Auth Coverage
        if: ${{ needs.check-changes.outputs.modules != '' && toJson(fromJson(needs.check-changes.outputs.modules)) != '[]' }}
        uses: davelosert/vitest-coverage-report-action@v2
        with:
          name: 'Auth'
          working-directory: 'packages/auth'
      - name: Report Common Coverage
        if: ${{ needs.check-changes.outputs.modules != '' && toJson(fromJson(needs.check-changes.outputs.modules)) != '[]' }}
        uses: davelosert/vitest-coverage-report-action@v2
        with:
          name: 'Common'
          working-directory: 'packages/common'
      - name: Report Event-Producer Coverage
        if: ${{ needs.check-changes.outputs.modules != '' && toJson(fromJson(needs.check-changes.outputs.modules)) != '[]' }}
        uses: davelosert/vitest-coverage-report-action@v2
        with:
          name: 'Event Producer'
          json-summary-path: 'packages/event-producer/coverage/coverage-final.json'
          json-final-path: 'packages/event-producer/coverage/coverage-summary.json'
          working-directory: 'packages/event-producer'
          vite-config-path: 'packages/event-producer/vite.config.ts'
      - name: Report Player-Web-Components Coverage
        if: ${{ needs.check-changes.outputs.modules != '' && toJson(fromJson(needs.check-changes.outputs.modules)) != '[]' }}
        uses: davelosert/vitest-coverage-report-action@v2
        with:
          name: 'Player Web Components'
          working-directory: 'packages/player-web-components'
      - name: Report True-Time Coverage
        if: ${{ needs.check-changes.outputs.modules != '' && toJson(fromJson(needs.check-changes.outputs.modules)) != '[]' }}
        uses: davelosert/vitest-coverage-report-action@v2
        with:
          name: 'True Time'
          working-directory: 'packages/true-time'
